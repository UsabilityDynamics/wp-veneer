# WordPress Network
#
# Examples:
# * http://capitaldealsonline.com/assets/scripts/admin-bar.js
# * http://capitaldealsonline.com/assets/styles/admin-bar.css
#
# @version 0.6.8
# @author potanin@UD

# BEGIN Environment
<IfModule mod_setenvif.c>
  SetEnvIfNoCase X-UDS-Environment "(.*)" APPLICATION_ENVIRONMENT=$1
</IfModule>
# END Environment

# Required at beginning
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
</IfModule>

# BEGIN Mimes
<IfModule mod_mime.c>
  AddEncoding gzip svgz
  AddType audio/mp4 m4a f4a f4b
  AddType audio/ogg oga ogg
  AddType application/javascript js
  AddType application/json json
  AddType video/mp4 mp4 m4v f4v f4p
  AddType video/ogg ogv
  AddType video/webm webm
  AddType video/x-flv flv
  AddType application/font-woff woff
  AddType application/vnd.ms-fontobject eot
  AddType application/x-font-ttf ttc ttf
  AddType font/opentype otf
  AddType application/octet-stream safariextz
  AddType application/x-chrome-extension crx
  AddType application/x-opera-extension oex
  AddType application/x-shockwave-flash swf
  AddType application/x-web-app-manifest+json webapp
  AddType application/x-xpinstall xpi
  AddType application/xml atom rdf rss xml
  AddType image/webp webp
  AddType image/x-icon ico
  AddType text/cache-manifest appcache manifest
  AddType text/vtt vtt
  AddType text/x-component htc
  AddType text/x-vcard vcf
</IfModule>
# END Mimes

# BEGIN Format
<IfModule mod_mime.c>
  AddCharset utf-8 .atom .css .js .json .rss .vtt .webapp .xml .html .htm
</IfModule>
# END Format

# BEGIN Security
<FilesMatch "(^#.*#|\.(md|lock|yml|json|bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~)$">
  Order allow,deny
  Deny from all
  Satisfy All
</FilesMatch>
# END Security

# BEGIN Static Cache
<IfModule mod_headers.c>

  <FilesMatch "\.(ttf|ttc|otf|eot|woff|font.css)$">
    Header set Cache-Control "max-age=290304000, public"
    Header set Expires "Thu, 15 Apr 2015 20:00:00 GMT"
    Header set Access-Control-Allow-Origin "*"
  </FilesMatch>

  <FilesMatch "\.(js|css)$">
    Header set Cache-Control "public, max-age=290304000"
    Header set Expires "Thu, 15 Apr 2015 20:00:00 GMT"
  </FilesMatch>

  <FilesMatch "\.(xml|json)$">
    Header set Cache-Control "public, must-revalidate, max-age=172800"
  </FilesMatch>

  <FilesMatch "\.(html|htm)$">
    Header set Cache-Control "max-age=7200, must-revalidate"
    Header set Access-Control-Allow-Origin "*"
  </FilesMatch>

</IfModule>
# END Static Cache

# BEGIN Browser Optimization
<IfModule mod_deflate.c>

  <IfModule mod_headers.c>
    Header append Vary User-Agent env=!dont-vary
  </IfModule>
    AddOutputFilterByType DEFLATE text/css text/x-component application/x-javascript application/javascript text/javascript text/x-js text/html text/richtext image/svg+xml text/plain text/xsd text/xsl text/xml image/x-icon application/json
  <IfModule mod_mime.c>
    # DEFLATE by extension
    AddOutputFilter DEFLATE js css htm html xml
  </IfModule>

</IfModule>
# END Browser Optimization

# BEGIN Static and Media
<IfModule mod_rewrite.c>

  # Rewrite any of our content URLs to media, so that it is uniform
  RewriteRule ^wp-content/uploads/(.*)$ /media/$1 [L]
  RewriteRule ^system/files/(.*)$ /media/$1 [L]
  RewriteRule ^system/media/(.*)$ /media/$1 [L]
  RewriteRule ^files/(.*)$ /media/$1 [L]
  RewriteRule ^uploads/(.*)$ /media/$1 [L]

  # Rewrite static assets specifically to the static directory if they exist:
  # http://wildwood.beachblanketfestival.com/img/logo-small.png
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{HTTP_HOST}::%{REQUEST_URI} ^(.*)::/(.*)$
  RewriteCond %{DOCUMENT_ROOT}/storage/public/%1/static/%2 -f
  RewriteRule ^(.*) /storage/public/%1/static/%2 [L]

  # Now, we're going to look in the public directory to see if the file exists, and serve
  # it if it does, this URL should work:
  # http://discodonniepresents.com/media/2014/04/4e46e8caed44b6ceae3f26cb48d321da78-890x460.jpg
  # -AND-
  # http://wildwood.beachblanketfestival.com/static/img/logo-small.png
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{HTTP_HOST}::%{REQUEST_URI} ^(.*)::/(.*)$
  RewriteCond %{DOCUMENT_ROOT}/storage/public/%1/%2 -f
  RewriteRule ^.*$ /storage/public/%1/%2 [L]

  # Now, look to see if we have a subdomain, with the request so we can properly route
  # it:
  # http://media.discodonniepresents.com/media/2014/04/4e46e8caed44b6ceae3f26cb48d321da78-890x460.jpg
  # -OR-
  # http://media.discodonniepresents.com/2014/04/4e46e8caed44b6ceae3f26cb48d321da78-890x460.jpg
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{HTTP_HOST}::%{REQUEST_URI} ^(assets|media|cache|static)\.(.*)::/(?:assets|media|cache|static)?/?(.*)$
  RewriteCond %{DOCUMENT_ROOT}/storage/public/%2/%1/%3 -f
  RewriteRule ^.*$ /storage/public/%2/%1/%3 [L]

  # Rewrite static index HTML that exist in the storage directory with a sub-directory
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{HTTP_HOST}::%{REQUEST_URI} ^(.*)::/(.*)$
  RewriteCond %{DOCUMENT_ROOT}/storage/public/%1/static/%2index.html -f
  RewriteRule ^.*$ /storage/public/%1/static/%2index.html [NC,QSA,L]

  # Ok, now we're going to rewrite to static html files if they exist
  # for the request
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{HTTP_HOST}::%{REQUEST_URI} ^(.*)::/(.*)$
  RewriteCond %{DOCUMENT_ROOT}/storage/public/%1/static/%2.html -f
  RewriteRule ^.*$ /storage/public/%1/static/%2.html [L]

  # Look to rewrite for the root specifically to index.html if it exists,
  # but only if we don't actually have a query string
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{DOCUMENT_ROOT}/storage/public/%{HTTP_HOST}/static/index\.html -f
  RewriteCond %{QUERY_STRING} ^$
  RewriteRule ^$ /storage/public/%{HTTP_HOST}/static/index.html [L]


</IfModule>
# END Static and Media

# BEGIN Veneer.io
<IfModule mod_rewrite.c>
  RewriteRule ^documents/(.*)$  http://api.veneer.io/documents/$1 [P,L]
  RewriteRule ^search/(.*)$     http://api.veneer.io/search/$1 [P,L]
</IfModule>

# END Veneer.io

# BEGIN Media Bucket
<IfModule mod_rewrite.c>
  # Media failover to GCE bucket..   ## https://storage.googleapis.com/xlufuwzldcekbrer
  #RewriteCond %{ENV:WP_MEDIA_BACKEND} !^$
  #SetEnvIf X-Branch develop WP_MEDIA_BACKEND=https://storage.googleapis.com/xlufuwzldcekbrer
  #RewriteCond %{REQUEST_FILENAME} !-f
  #RewriteCond %{REQUEST_FILENAME} !-d
  #RewriteCond %{HTTP_HOST} ^(?:www\.)?(.+)$
  #RewriteRule ^media/(.*) %{ENV:WP_MEDIA_BACKEND}/%1/media/$1 [R=302,L]
  #RewriteRule ^media/(.*) %{ENV:WP_MEDIA_BACKEND}/%1/media/$1 [R=302,L]
  #RewriteRule ^.*$ http://localhost:4000%{REQUEST_URI} [P,QSA,L]
</IfModule>
# END Media Bucket

# BEGIN Public API
<IfModule mod_rewrite.c>

  # Now, if we have a subdomain request to API, forward it to admin AJAX, these requests are like follows:
  # http://api.discodonniepresents.com/some/path/to/api
  # -OR-
  # http://api.discodonniepresents.com/api/some/path/to/api
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_URI} !^.*admin-ajax\.php.*$
  #RewriteCond %{HTTP_HOST}::%{REQUEST_URI} ^(api)\.(.*)::/(?:api)?/?(.*)$
  #RewriteRule ^.*$ /manage/admin-ajax.php?action=/%3&format=json [L]

  # Do our default API requests
  RewriteRule ^xmlrpc.php$ /vendor/libraries/automattic/wordpress/xmlrpc.php [QSA,L]
  RewriteRule ^api/rpc.xml$ /vendor/libraries/automattic/wordpress/xmlrpc.php [QSA,L]
  RewriteRule ^api/rpc.json$ /manage/admin-ajax.php?action=/api/json-rpc [QSA,L]
  RewriteRule ^api/(.*).xml$ /manage/admin-ajax.php?action=/$1&format=xml [QSA,L]
  RewriteRule ^api/(.*).json$ /manage/admin-ajax.php?action=/$1&format=json [QSA,L]
  #RewriteRule ^api/(.*)$ /manage/admin-ajax.php?action=/$1&format=json [QSA,L]

</IfModule>
# END Public API

# BEGIN Legacy
# These rewrites exist to fix old or broken functionality
<IfModule mod_rewrite.c>

  # Rewrite old to new location for vendor libraries
  RewriteCond %{REQUEST_URI} !^/vendor/(libraries|modules|plugins|themes)/(.*)
  RewriteRule ^vendor/(.*) /vendor/libraries/$1 [R=301,L]

  # Rewrite old modules/themes
  RewriteRule ^themes/(.*)$ /vendor/themes/$1 [QSA,L]
  RewriteRule ^modules/(.*)$ /vendor/plugins/$1 [QSA,L]
  RewriteRule ^plugins/(.*)$ /vendor/plugins/$1 [QSA,L]

  # Just do a standard rewrite for plugins to vendor conversion
  RewriteRule ^libraries/(.*)$ vendor/libraries/$1 [QSA,L]

  # Rewrite anything in wp-content
  RewriteRule ^wp-content/plugins/(.*)$ vendor/plugins/$1 [QSA,L]
  RewriteRule ^wp-content/themes/(.*)$ vendor/themes/$1 [QSA,L]
  RewriteRule ^wp-content/vendor/(.*)$ vendor/$1 [R=301,L] # DO NOT REMOVE

</IfModule>
# END Legacy

# BEGIN Assets
<IfModule mod_rewrite.c>

  RewriteRule ^includes/js/(.*)$ /assets/scripts/$1 [QSA,L]
  RewriteRule ^includes/css/(.*)$ /assets/styles/$1 [QSA,L]

  RewriteRule ^wp-includes/js/(.*)$ /assets/scripts/$1 [QSA,L]
  RewriteRule ^wp-includes/images/(.*)$ /assets/images/$1 [QSA,L]
  RewriteRule ^wp-includes/css/(.*)$ /assets/styles/$1 [R=301,L]

  RewriteRule ^assets/styles/(.*)$ /vendor/libraries/automattic/wordpress/wp-includes/css/$1 [QSA,L]
  RewriteRule ^assets/scripts/(.*)$ /vendor/libraries/automattic/wordpress/wp-includes/js/$1 [QSA,L]
  RewriteRule ^assets/images/(.*)$ /vendor/libraries/automattic/wordpress/wp-includes/images/$1 [QSA,L]

</IfModule>
# END Assets

# BEGIN Management
<IfModule mod_rewrite.c>


  RewriteRule ^wp-admin/admin-ajax.php?(.*)$  /vendor/libraries/automattic/wordpress/wp-admin/admin-ajax.php$1  [QSA,L]

  RewriteRule ^wp-admin/js/?(.*)$             /manage/js/$1           [QSA,L]
  RewriteRule ^wp-admin/css/?(.*)$            /manage/css/$1          [QSA,L]
  RewriteRule ^wp-admin/images/?(.*)$         /manage/images/$1       [QSA,L]
  RewriteRule ^wp-login.php$                  /manage/login/          [R=301,L]
  RewriteRule ^wp-admin$                      /manage/                [R=301,L]
  RewriteRule ^wp-admin/install.php?(.*)$     /manage/install.php$1   [R=301,L]

  # Must have the following to avoid having a broken admin panel
  RewriteRule ^manage$                         /manage/ [R=301,L]

  # Ensure that we're forwarding all manage requests to the right place
  RewriteRule ^manage/(login|signup)/?(.*)$    /vendor/libraries/automattic/wordpress/wp-$1.php [QSA,L]
  RewriteRule ^manage/?(.*)$                   /vendor/libraries/automattic/wordpress/wp-admin/$1 [QSA,L]

  # Without this, Media Libary can't make admin-ajax requests...
  RewriteRule ^vendor/libraries/automattic/wordpress/manage/?(.*)$ /manage/$1 [QSA,L]

  # Script Builders.
  RewriteRule ^wp-admin/load-styles.php?(.*)$ /vendor/libraries/automattic/wordpress/wp-admin/load-styles.php$1 [QSA,L]
  RewriteRule ^wp-admin/load-scripts.php?(.*)$ /vendor/libraries/automattic/wordpress/wp-admin/load-scripts.php$1 [R=301,L]

</IfModule>
# END Management

# BEGIN PHP-FPM
<IfModule mod_proxy_fcgi.c>
  <IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_FILENAME} ^.*\.php$
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^(.*\.php(/.*)?)$ fcgi://127.0.0.1:9000/var/www/$1 [P,L]
  </IfModule>
</IfModule>
# END PHP-FPM

# BEGIN WordPress
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.php$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.php [L]
</IfModule>
# END WordPress